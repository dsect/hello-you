name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Cache npm dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy migrations to hello-you-dev
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DEV_DB_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying migrations to hello-you-dev..."
          supabase link --project-ref ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
          supabase db push

      - name: Seed hello-you-dev database
        env:
          SUPABASE_DEV_DB_PASSWORD: ${{ secrets.SUPABASE_DEV_DB_PASSWORD }}
          PGPASSWORD: ${{ secrets.SUPABASE_DEV_DB_PASSWORD }}
        run: |
          echo "ðŸŒ± Seeding hello-you-dev..."
          # Install postgresql-client for psql
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql "postgresql://postgres.wizxpsdetombktnqtdub:${SUPABASE_DEV_DB_PASSWORD}@aws-0-us-east-1.pooler.supabase.com:6543/postgres" < supabase/seeds/us_states.sql

      - name: Set up environment for hello-you-dev
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_DEV_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_DEV_ANON_KEY }}
        run: |
          echo "VITE_SUPABASE_URL=$VITE_SUPABASE_URL" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=$VITE_SUPABASE_ANON_KEY" >> .env.local

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps

      - name: Run all Playwright tests (e2e)
        run: |
          npm run dev &
          npx playwright test
