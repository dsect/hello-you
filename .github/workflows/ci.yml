name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # ubuntu-latest has Node 20 as default, but Node 22 is cached locally
      # setup-node just symlinks to it (no download)
      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      # Wait for "Supabase Preview" check using GitHub CLI (more trustworthy than third-party actions)
      - name: Wait for Supabase Preview check to complete
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Waiting for Supabase Preview check on commit $COMMIT_SHA..."
          echo ""
          
          for i in {1..12}; do
            echo "=== Attempt $i/12 ==="
            
            # Get all check runs for this commit
            CHECKS=$(gh api repos/${{ github.repository }}/commits/${COMMIT_SHA}/check-runs)
            echo "Available checks:"
            echo "$CHECKS" | jq -r '.check_runs[] | "  - \(.name): status=\(.status) conclusion=\(.conclusion)"'
            
            echo ""
            
            # Find the Supabase Preview check
            RESPONSE=$(echo "$CHECKS" | jq '.check_runs[] | select(.name=="Supabase Preview")')
            
            if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
              echo "Supabase Preview check not found yet"
              if [ $i -lt 12 ]; then
                echo "Sleeping 5 seconds..."
                sleep 5
              fi
              continue
            fi
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status')
            CONCLUSION=$(echo "$RESPONSE" | jq -r '.conclusion')
            
            echo "Supabase Preview check:"
            echo "  Status: $STATUS"
            echo "  Conclusion: $CONCLUSION"
            echo ""
            
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "✓ Supabase Preview check PASSED"
                exit 0
              else
                echo "✗ Supabase Preview check FAILED with conclusion: $CONCLUSION"
                exit 1
              fi
            fi
            
            if [ $i -lt 12 ]; then
              echo "Check still in progress, sleeping 5 seconds..."
              sleep 5
            fi
          done
          
          echo ""
          echo "✗ TIMEOUT after 60 seconds - Supabase Preview check never completed"
          exit 1

      - name: Export preview branch credentials
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          set -euo pipefail
          
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Getting credentials for branch: $BRANCH_NAME"
          
          # Get branch configuration from Supabase Management API
          BRANCH_CONFIG=$(curl -s \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
            "https://api.supabase.com/v1/branches?project_ref=${SUPABASE_PROJECT_REF}" | \
            jq -r ".[] | select(.git_branch==\"${BRANCH_NAME}\") | {ref}")
          
          BRANCH_REF=$(echo "$BRANCH_CONFIG" | jq -r '.ref')
          
          if [ "$BRANCH_REF" = "null" ] || [ -z "$BRANCH_REF" ]; then
            echo "Error: Could not find branch $BRANCH_NAME in Supabase"
            exit 1
          fi
          
          echo "Branch ref: $BRANCH_REF"
          
          # Get the anon key from the branch's API keys
          ANON_KEY=$(curl -s \
            -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
            "https://api.supabase.com/v1/projects/${BRANCH_REF}/api-keys" | \
            jq -r '.[] | select(.type=="anon") | .api_key')
          
          if [ "$ANON_KEY" = "null" ] || [ -z "$ANON_KEY" ]; then
            echo "Error: Could not retrieve anon key"
            exit 1
          fi
          
          echo "SUPABASE_URL=https://${BRANCH_REF}.supabase.co" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${ANON_KEY}" >> $GITHUB_ENV
          echo ""
          echo "✓ Successfully retrieved preview branch credentials"

      - name: Set up environment (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- E2E Tests ---
      # Playwright needs:
      # 1. Its own browser binaries (patched versions, not system Chrome/Firefox)
      # 2. System dependencies (--with-deps: fonts, libs, etc.)
      # Takes ~45s but necessary for hermetic test environment
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test
