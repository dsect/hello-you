name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Cache npm dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      - name: Setup Supabase CLI
        if: github.event_name == 'pull_request'
        uses: supabase/setup-cli@v1
        with:
          version: 1.215.3

      - name: Wait for Supabase Preview deployment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for Supabase Preview deployment..."
          for i in {1..60}; do
            STATUS=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs \
              --jq '.check_runs[] | select(.name == "Supabase Preview") | .status + ":" + (.conclusion // "pending")')
            
            if [[ "$STATUS" == "completed:success" ]]; then
              echo "Supabase Preview deployed successfully"
              exit 0
            elif [[ "$STATUS" == "completed:"* ]]; then
              echo "Supabase Preview failed: $STATUS"
              exit 1
            fi
            
            echo "Waiting... (attempt $i/60)"
            sleep 5
          done
          
          echo "Timeout waiting for Supabase Preview"
          exit 1

      - name: Get preview branch credentials
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
          BRANCH_ENV=$(supabase --experimental branches get "${{ github.head_ref }}" -o env)
          echo "$BRANCH_ENV" | grep "^SUPABASE_URL=" | sed 's/"//g' >> $GITHUB_ENV
          echo "$BRANCH_ENV" | grep "^SUPABASE_ANON_KEY=" | sed 's/"//g' >> $GITHUB_ENV

      - name: Set up environment (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- E2E Tests ---
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test
