name: CI
run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    env:
      WORKDIR_APP: apps/web
      WORKDIR_SUPABASE: apps/web/supabase
    defaults:
      run:
        working-directory: ${{ env.WORKDIR_APP }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKDIR_APP }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      - name: Wait for Supabase Preview check to complete
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Waiting for Supabase Preview check on $COMMIT_SHA"
          for i in {1..24}; do
            CHECKS=$(gh api repos/${{ github.repository }}/commits/${COMMIT_SHA}/check-runs)
            RESPONSE=$(echo "$CHECKS" | jq '.check_runs[] | select(.name=="Supabase Preview")')
            if [ -n "$RESPONSE" ] && [ "$RESPONSE" != "null" ]; then
              STATUS=$(echo "$RESPONSE" | jq -r '.status')
              CONCLUSION=$(echo "$RESPONSE" | jq -r '.conclusion')
              echo "Supabase Preview status=$STATUS conclusion=$CONCLUSION"
              if [ "$STATUS" = "completed" ]; then
                [ "$CONCLUSION" = "success" ]
                exit 0
              fi
            fi
            sleep 5
          done
          echo "Timeout waiting for Supabase Preview check"
          exit 1

      - name: Install Supabase CLI
        if: github.event_name == 'pull_request'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Preview diagnostics and env export
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_REF: ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
        run: |
          set -euo pipefail
          BRANCH_NAME="${{ github.head_ref }}"

          echo "--- CLI version"
          supabase --version || true

          echo "--- Repository info"
          echo "Repo: ${{ github.repository }}"
          echo "PR branch: $BRANCH_NAME"
          echo "Project ref: $PROJECT_REF"
          echo "Workdir (app): $WORKDIR_APP"
          echo "Workdir (supabase): $WORKDIR_SUPABASE"
          echo

          echo "--- Supabase config.toml existence"
          CFG="$WORKDIR_SUPABASE/config.toml"
          if [ -f "$CFG" ]; then
            echo "Found: $CFG"
            head -n 200 "$CFG" || true
          else
            echo "Missing: $CFG"
          fi
          echo

          echo "--- Fetching preview branch info (raw)"
          INFO=$(supabase branches get "$BRANCH_NAME" --project-ref "$PROJECT_REF" -o json)
          echo "$INFO" | jq . || true

          echo "--- Extracting required fields"
          POSTGRES_URL=$(echo "$INFO" | jq -r .POSTGRES_URL)
          SUPABASE_URL=$(echo "$INFO" | jq -r .SUPABASE_URL)
          SUPABASE_ANON_KEY=$(echo "$INFO" | jq -r .SUPABASE_ANON_KEY)

          [ -n "$POSTGRES_URL" ] && [ "$POSTGRES_URL" != "null" ] || { echo "Missing POSTGRES_URL from branches get"; exit 1; }
          [ -n "$SUPABASE_URL" ] && [ "$SUPABASE_URL" != "null" ] || { echo "Missing SUPABASE_URL from branches get"; exit 1; }
          [ -n "$SUPABASE_ANON_KEY" ] && [ "$SUPABASE_ANON_KEY" != "null" ] || { echo "Missing SUPABASE_ANON_KEY from branches get"; exit 1; }

          # Redacted echo (no secrets leak)
          echo "Derived:"
          echo "- POSTGRES_URL present: yes"
          echo "- SUPABASE_URL: $SUPABASE_URL"
          echo "- SUPABASE_ANON_KEY present: yes"
          echo

          echo "PREVIEW_POSTGRES_URL=$POSTGRES_URL" >> $GITHUB_ENV
          echo "SUPABASE_URL=$SUPABASE_URL" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> $GITHUB_ENV

          echo "--- Migration files present"
          if [ -d "$WORKDIR_SUPABASE/migrations" ]; then
            ls -lah "$WORKDIR_SUPABASE/migrations" || true
          else
            echo "No migrations directory at $WORKDIR_SUPABASE/migrations"
          fi
          echo

          echo "--- Seed files configured"
          if [ -f "$CFG" ]; then
            # naive list of referenced sql_paths
            awk '/^\[db.seed\]/,0{print}' "$CFG" || true
          fi

      - name: Preview snapshot BEFORE migrations
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          echo "--- DB snapshot (roles/tables/extensions) BEFORE"
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "\du+" || true
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "\dn+" || true
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "\dt+ public.*" || true
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "select extname, extversion from pg_extension order by 1;" || true

      - name: Preview migrations (dry-run) and apply
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          echo "--- supabase db push (dry-run)"
          supabase db push \
            --db-url "$PREVIEW_POSTGRES_URL" \
            --workdir "$WORKDIR_SUPABASE" \
            --dry-run \
            --yes

          echo "--- supabase db push (apply)"
          supabase db push \
            --db-url "$PREVIEW_POSTGRES_URL" \
            --workdir "$WORKDIR_SUPABASE" \
            --yes

      - name: Preview seeds
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          echo "--- supabase db seed"
          if ! supabase db seed --db-url "$PREVIEW_POSTGRES_URL" --workdir "$WORKDIR_SUPABASE" --yes; then
            echo "db seed failed; attempting reset with seed"
            supabase db reset --db-url "$PREVIEW_POSTGRES_URL" --workdir "$WORKDIR_SUPABASE" --include-seed --yes
          fi

      - name: Preview snapshot AFTER migrations
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          echo "--- DB snapshot (roles/tables/extensions) AFTER"
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "\dt+ public.*" || true
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -c "select extname, extversion from pg_extension order by 1;" || true

          echo "--- RLS status summary (public schema)"
          psql "$PREVIEW_POSTGRES_URL" -v ON_ERROR_STOP=1 -P pager=off -F $'\t' -A -c \
            "select table_schema, table_name, relrowsecurity as rls_enabled
             from pg_class c
             join pg_namespace n on n.oid=c.relnamespace
             where n.nspname='public' and c.relkind='r'
             order by 1,2;" || true

      - name: Preview app env for PR
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Preview smoke checks (PostgREST + anon)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          echo "--- Verify anon can reach auth endpoint"
          curl -sSf -H "apikey: ${SUPABASE_ANON_KEY}" "${SUPABASE_URL}/auth/v1/health" || true

          echo "--- Verify PostgREST reachable (should 200/404)"
          curl -s -o /dev/null -w "%{http_code}\n" -H "apikey: ${SUPABASE_ANON_KEY}" "${SUPABASE_URL}/rest/v1/" || true

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- E2E Tests ---
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test