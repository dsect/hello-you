name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # ubuntu-latest has Node 20 as default, but Node 22 is cached locally
      # setup-node just symlinks to it (no download)
      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      # Use Management API directly (no CLI linking needed, just token + project ID)
      - name: Wait for preview branch and get credentials
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          set -euo pipefail
          
          echo "=== Finding Supabase project ==="
          PROJECTS=$(curl -s -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
            https://api.supabase.com/v1/projects)
          echo "Projects response: $PROJECTS" | jq '.' || echo "$PROJECTS"
          
          PROJECT_REF=$(echo "$PROJECTS" | jq -r '.[] | select(.name=="hello-you-dev") | .id' | head -1)
          
          if [ -z "$PROJECT_REF" ]; then
            echo "Error: Could not find hello-you-dev project"
            exit 1
          fi
          echo "✓ Found project ref: $PROJECT_REF"
          
          # Wait for preview branch to be ready
          BRANCH_NAME="${{ github.head_ref }}"
          echo ""
          echo "=== Waiting for preview branch '$BRANCH_NAME' to be ready ==="
          
          for i in {1..12}; do
            echo ""
            echo "Attempt $i/12..."
            RESPONSE=$(curl -s -H "Authorization: Bearer ${SUPABASE_ACCESS_TOKEN}" \
              "https://api.supabase.com/v1/projects/${PROJECT_REF}/branches/${BRANCH_NAME}" || echo '{}')
            
            echo "Raw API response:"
            echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
            
            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
            echo "Parsed status: '$STATUS'"
            
            if [ "$STATUS" = "HEALTHY" ]; then
              echo ""
              echo "✓ Preview branch is ready!"
              
              # Extract credentials - show what we're getting
              POSTGRES_URL=$(echo "$RESPONSE" | jq -r '.db_url // empty')
              ANON_KEY=$(echo "$RESPONSE" | jq -r '.anon_key // empty')
              
              echo "Extracted credentials:"
              echo "  POSTGRES_URL: ${POSTGRES_URL:0:50}..."
              echo "  ANON_KEY: ${ANON_KEY:0:20}..."
              
              echo "POSTGRES_URL_NON_POOLING=${POSTGRES_URL}" >> $GITHUB_ENV
              echo "SUPABASE_URL=$(echo ${POSTGRES_URL} | sed 's|/postgres$||')" >> $GITHUB_ENV
              echo "SUPABASE_ANON_KEY=${ANON_KEY}" >> $GITHUB_ENV
              exit 0
            fi
            
            if [ $i -lt 12 ]; then
              echo "Status not ready, sleeping 5 seconds..."
              sleep 5
            fi
          done
          
          echo ""
          echo "✗ Timeout after 60 seconds - branch never became HEALTHY"
          exit 1

      - name: Smoke checks (DB/Auth/Storage)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          psql "$POSTGRES_URL_NON_POOLING" -c 'select 1'
          curl -sf "$SUPABASE_URL/auth/v1/health" >/dev/null
          curl -sf "$SUPABASE_URL/storage/v1/health" >/dev/null

      - name: Set up environment (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- E2E Tests ---
      # Playwright needs:
      # 1. Its own browser binaries (patched versions, not system Chrome/Firefox)
      # 2. System dependencies (--with-deps: fonts, libs, etc.)
      # Takes ~45s but necessary for hermetic test environment
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test
