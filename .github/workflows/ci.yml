name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Gate: wait until Supabase preview branch is fully provisioned
  # Pattern from: https://supabase.com/docs/guides/deployment/branching
  wait-for-preview:
    name: Wait for Preview Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      ready: ${{ steps.gate.outputs.ready }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Wait until Supabase preview branch is ready
        id: gate
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Waiting for Supabase branch '$GITHUB_HEAD_REF' to be ready..."
          for i in {1..120}; do
            STATUS=$(supabase --experimental branches status "$GITHUB_HEAD_REF" --json 2>/dev/null | jq -r '.status // empty')
            if [ "$STATUS" = "ready" ]; then
              echo "✓ Preview branch is ready"
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if [ "$STATUS" = "failed" ]; then
              echo "✗ Branch provisioning failed"
              exit 1
            fi
            echo "Branch status: ${STATUS:-pending} (attempt $i/120)"
            sleep 5
          done
          echo "✗ Timeout waiting for branch readiness"
          exit 1

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: wait-for-preview
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && needs.wait-for-preview.outputs.ready == 'true')
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # ubuntu-latest has Node 20 as default, but Node 22 is cached locally
      # setup-node just symlinks to it (no download)
      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      - name: Setup Supabase CLI
        if: github.event_name == 'pull_request'
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Export preview branch credentials
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Only extract the two credentials needed for tests
          supabase --experimental branches get "${{ github.head_ref }}" -o env | grep -E "^SUPABASE_(URL|ANON_KEY)=" >> $GITHUB_ENV
          # Also grab database URLs for bootstrap and smoke checks
          supabase --experimental branches get "${{ github.head_ref }}" -o env | grep -E "^POSTGRES_URL" >> $GITHUB_ENV

      - name: Smoke checks (DB/Auth/Storage)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          psql "$POSTGRES_URL_NON_POOLING" -c 'select 1'
          curl -sf "$SUPABASE_URL/auth/v1/health" >/dev/null
          curl -sf "$SUPABASE_URL/storage/v1/health" >/dev/null

      - name: Bootstrap E2E data (idempotent)
        if: github.event_name == 'pull_request'
        run: |
          # Run idempotent bootstrap SQL to ensure test data is present
          # This runs on EVERY commit, so tests always have fresh data
          psql "$POSTGRES_URL_NON_POOLING" -v "ON_ERROR_STOP=1" -f supabase/bootstrap-e2e.sql

      - name: Set up environment (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- E2E Tests ---
      # Playwright needs:
      # 1. Its own browser binaries (patched versions, not system Chrome/Firefox)
      # 2. System dependencies (--with-deps: fonts, libs, etc.)
      # Takes ~45s but necessary for hermetic test environment
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test
