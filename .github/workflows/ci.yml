name: CI

run-name: "CI - ${{ github.head_ref || github.ref_name }}"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Use Node.js 22
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 22

      - name: Cache npm dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

      # --- Supabase Preview Branch Setup (PRs only) ---
      - name: Setup Supabase CLI
        if: github.event_name == 'pull_request'
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Wait for Supabase Preview deployment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for Supabase Preview deployment..."
          for i in {1..60}; do
            STATUS=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs \
              --jq '.check_runs[] | select(.name == "Supabase Preview") | .status + ":" + (.conclusion // "pending")')
            
            if [[ "$STATUS" == "completed:success" ]]; then
              echo "Supabase Preview deployed successfully"
              exit 0
            elif [[ "$STATUS" == "completed:"* ]]; then
              echo "Supabase Preview failed: $STATUS"
              exit 1
            fi
            
            echo "Waiting... (attempt $i/60)"
            sleep 5
          done
          
          echo "Timeout waiting for Supabase Preview"
          exit 1

      - name: Get preview branch credentials
        if: github.event_name == 'pull_request'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_DEV_PROJECT_ID }}
          # Extract only public values, strip quotes
          BRANCH_ENV=$(supabase --experimental branches get "${{ github.head_ref }}" -o env)
          echo "$BRANCH_ENV" | grep "^SUPABASE_URL=" | sed 's/"//g' >> $GITHUB_ENV
          echo "$BRANCH_ENV" | grep "^SUPABASE_ANON_KEY=" | sed 's/"//g' >> $GITHUB_ENV

      - name: Set up environment (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "VITE_SUPABASE_URL=${SUPABASE_URL}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}" >> .env.local

      - name: Set up environment (push to main)
        if: github.event_name == 'push'
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.SUPABASE_DEV_URL }}" > .env.local
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_DEV_ANON_KEY }}" >> .env.local

      # --- Debug: Answer ALL the questions before Playwright ---
      - name: "Debug 1: Is Supabase reachable?"
        run: |
          source .env.local
          echo "=== SUPABASE CONNECTIVITY CHECK ==="
          echo "URL: $VITE_SUPABASE_URL"
          echo "Key length: ${#VITE_SUPABASE_ANON_KEY} chars"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: $VITE_SUPABASE_ANON_KEY" \
            "$VITE_SUPABASE_URL/rest/v1/")
          echo "REST API response: $RESPONSE"
          
          if [ "$RESPONSE" = "200" ]; then
            echo "✅ Supabase REST API is reachable"
          else
            echo "❌ Supabase REST API returned $RESPONSE"
            exit 1
          fi

      - name: "Debug 2: Check and seed us_states if needed"
        run: |
          source .env.local
          echo "=== CHECKING us_states TABLE ==="
          
          # Get count
          ROWS=$(curl -s \
            -H "apikey: $VITE_SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $VITE_SUPABASE_ANON_KEY" \
            "$VITE_SUPABASE_URL/rest/v1/us_states?select=id,name,code&limit=5")
          echo "Current rows: $ROWS"
          
          if echo "$ROWS" | grep -q "CA"; then
            echo "✅ us_states already has data"
          else
            echo "⚠️ us_states is empty, seeding via REST API..."
            
            # Seed using REST API
            SEED_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
              -X POST \
              -H "apikey: $VITE_SUPABASE_ANON_KEY" \
              -H "Authorization: Bearer $VITE_SUPABASE_ANON_KEY" \
              -H "Content-Type: application/json" \
              -H "Prefer: return=minimal" \
              "$VITE_SUPABASE_URL/rest/v1/us_states" \
              -d '[
                {"name":"Alabama","code":"AL"},{"name":"Alaska","code":"AK"},
                {"name":"Arizona","code":"AZ"},{"name":"Arkansas","code":"AR"},
                {"name":"California","code":"CA"},{"name":"Colorado","code":"CO"},
                {"name":"Connecticut","code":"CT"},{"name":"Delaware","code":"DE"},
                {"name":"Florida","code":"FL"},{"name":"Georgia","code":"GA"},
                {"name":"Hawaii","code":"HI"},{"name":"Idaho","code":"ID"},
                {"name":"Illinois","code":"IL"},{"name":"Indiana","code":"IN"},
                {"name":"Iowa","code":"IA"},{"name":"Kansas","code":"KS"},
                {"name":"Kentucky","code":"KY"},{"name":"Louisiana","code":"LA"},
                {"name":"Maine","code":"ME"},{"name":"Maryland","code":"MD"},
                {"name":"Massachusetts","code":"MA"},{"name":"Michigan","code":"MI"},
                {"name":"Minnesota","code":"MN"},{"name":"Mississippi","code":"MS"},
                {"name":"Missouri","code":"MO"},{"name":"Montana","code":"MT"},
                {"name":"Nebraska","code":"NE"},{"name":"Nevada","code":"NV"},
                {"name":"New Hampshire","code":"NH"},{"name":"New Jersey","code":"NJ"},
                {"name":"New Mexico","code":"NM"},{"name":"New York","code":"NY"},
                {"name":"North Carolina","code":"NC"},{"name":"North Dakota","code":"ND"},
                {"name":"Ohio","code":"OH"},{"name":"Oklahoma","code":"OK"},
                {"name":"Oregon","code":"OR"},{"name":"Pennsylvania","code":"PA"},
                {"name":"Rhode Island","code":"RI"},{"name":"South Carolina","code":"SC"},
                {"name":"South Dakota","code":"SD"},{"name":"Tennessee","code":"TN"},
                {"name":"Texas","code":"TX"},{"name":"Utah","code":"UT"},
                {"name":"Vermont","code":"VT"},{"name":"Virginia","code":"VA"},
                {"name":"Washington","code":"WA"},{"name":"West Virginia","code":"WV"},
                {"name":"Wisconsin","code":"WI"},{"name":"Wyoming","code":"WY"}
              ]')
            
            HTTP_CODE=$(echo "$SEED_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$SEED_RESPONSE" | grep -v "HTTP_CODE:")
            echo "Seed response: $HTTP_CODE"
            echo "Body: $BODY"
            
            if [ "$HTTP_CODE" = "201" ]; then
              echo "✅ Seeded successfully!"
            else
              echo "❌ Seed failed with $HTTP_CODE"
              echo "This might mean RLS INSERT policy doesn't exist for anon"
              echo "Continuing anyway to see what happens..."
            fi
          fi
          
          # Verify final state
          FINAL=$(curl -s \
            -H "apikey: $VITE_SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $VITE_SUPABASE_ANON_KEY" \
            "$VITE_SUPABASE_URL/rest/v1/us_states?select=code&limit=5")
          echo "Final check: $FINAL"
          
          if echo "$FINAL" | grep -q "CA"; then
            echo "✅ us_states has data!"
          else
            echo "❌ us_states still empty"
            exit 1
          fi

      - name: "Debug 3: Can we query us_state_selections?"
        run: |
          source .env.local
          echo "=== CHECKING us_state_selections TABLE ==="
          
          RESPONSE=$(curl -s \
            -H "apikey: $VITE_SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $VITE_SUPABASE_ANON_KEY" \
            "$VITE_SUPABASE_URL/rest/v1/us_state_selections?select=*&limit=1")
          echo "Query response: $RESPONSE"
          
          # Check if it's an error or empty array (both are fine)
          if echo "$RESPONSE" | grep -q "^\[\]$\|^\["; then
            echo "✅ us_state_selections table is queryable"
          else
            echo "⚠️ Unexpected response from us_state_selections"
            echo "Response: $RESPONSE"
          fi

      - name: "Debug 4: Show .env.local contents (sanitized)"
        run: |
          echo "=== .env.local FILE ==="
          echo "File exists: $(test -f .env.local && echo 'YES' || echo 'NO')"
          echo "Line count: $(wc -l < .env.local)"
          echo "URL line: $(grep VITE_SUPABASE_URL .env.local | sed 's/=.*/=***/')"
          echo "Key line: $(grep VITE_SUPABASE_ANON_KEY .env.local | sed 's/=.*/=***/')"

      # --- E2E Tests ---
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start dev server
        run: npm run dev &

      - name: Wait for server
        run: sleep 2

      - name: "Debug 5: Check dev server is serving"
        run: |
          echo "=== DEV SERVER CHECK ==="
          curl -s http://localhost:5174 | head -20
          echo "---"
          echo "✅ Dev server is responding"

      - name: Run Playwright tests
        run: npx playwright test
