name: Promote Migrations to Production

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to promote (e.g., v1.2.0)'
        required: true
        type: string
      confirm:
        description: 'Type "PROMOTE" to confirm production deployment'
        required: true
        type: string

jobs:
  promote-to-prod:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "PROMOTE" ]; then
            echo "Confirmation failed. You must type 'PROMOTE' to proceed."
            exit 1
          fi

      - name: Checkout release tag
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.release_tag }}

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Deploy migrations to hello-you-prod
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_PROD_DB_PASSWORD }}
        run: |
          echo "Promoting migrations to PRODUCTION"
          echo "Release: ${{ inputs.release_tag }}"
          echo ""
          
          supabase link --project-ref ${{ secrets.SUPABASE_PROD_PROJECT_ID }}
          
          echo "Dry run - migrations to be applied:"
          supabase db push --dry-run || true
          echo ""
          
          echo "Applying migrations to production"
          supabase db push --include-seed
          
          echo ""
          echo "Migrations deployed successfully to PRODUCTION"
          echo "Project URL: https://${{ secrets.SUPABASE_PROD_PROJECT_ID }}.supabase.co"

      - name: Create deployment issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Deployment: ${{ inputs.release_tag }}`,
              body: `Database migrations from release **${{ inputs.release_tag }}** have been successfully deployed to **hello-you-prod**.\n\n**Deployed by:** @${{ github.actor }}\n**Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['deployment', 'production']
            });
            console.log(`Created issue #${issue.data.number}`);
